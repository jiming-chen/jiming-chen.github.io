<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A PostgreSQL Bug I Had to Deal With | Jiming Chen</title><meta name=keywords content><meta name=description content="Back in May, when first started working on one of my projects which uses PostgreSQL, I implemented a TypeScript edge function called delete-user that does exactly what you&rsquo;d expect it to do (among other things), and it worked fine back then. But two days ago, to my dismay, I tried deleting an account, and I received a 500 error from the API call.
After adding some logs, I narrowed the error down to this line:"><meta name=author content="Jiming Chen"><link rel=canonical href=https://jiming-chen.github.io/posts/securitydefiner/><link crossorigin=anonymous href=/assets/css/stylesheet.d20d31710e1e17ede7c7f9ededb138159f9228abc86b338e8d1053ed139865b7.css integrity="sha256-0g0xcQ4eF+3nx/nt7bE4FZ+SKKvIazOOjRBT7ROYZbc=" rel="preload stylesheet" as=style><link rel=icon href=https://jiming-chen.github.io/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jiming-chen.github.io/icons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jiming-chen.github.io/icons/favicon-32x32.png><link rel=apple-touch-icon href=https://jiming-chen.github.io/icons/apple-touch-icon.png><link rel=mask-icon href=https://jiming-chen.github.io/%3C/icons/apple-touch-icon.png%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://jiming-chen.github.io/posts/securitydefiner/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-KTD621L9T6"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KTD621L9T6")</script><meta property="og:url" content="https://jiming-chen.github.io/posts/securitydefiner/"><meta property="og:site_name" content="Jiming Chen"><meta property="og:title" content="A PostgreSQL Bug I Had to Deal With"><meta property="og:description" content="Back in May, when first started working on one of my projects which uses PostgreSQL, I implemented a TypeScript edge function called delete-user that does exactly what you‚Äôd expect it to do (among other things), and it worked fine back then. But two days ago, to my dismay, I tried deleting an account, and I received a 500 error from the API call.
After adding some logs, I narrowed the error down to this line:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-22T01:32:37-05:00"><meta property="article:modified_time" content="2025-07-22T01:32:37-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A PostgreSQL Bug I Had to Deal With"><meta name=twitter:description content="Back in May, when first started working on one of my projects which uses PostgreSQL, I implemented a TypeScript edge function called delete-user that does exactly what you&rsquo;d expect it to do (among other things), and it worked fine back then. But two days ago, to my dismay, I tried deleting an account, and I received a 500 error from the API call.
After adding some logs, I narrowed the error down to this line:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jiming-chen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"A PostgreSQL Bug I Had to Deal With","item":"https://jiming-chen.github.io/posts/securitydefiner/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A PostgreSQL Bug I Had to Deal With","name":"A PostgreSQL Bug I Had to Deal With","description":"Back in May, when first started working on one of my projects which uses PostgreSQL, I implemented a TypeScript edge function called delete-user that does exactly what you\u0026rsquo;d expect it to do (among other things), and it worked fine back then. But two days ago, to my dismay, I tried deleting an account, and I received a 500 error from the API call.\nAfter adding some logs, I narrowed the error down to this line:\n","keywords":[],"articleBody":"Back in May, when first started working on one of my projects which uses PostgreSQL, I implemented a TypeScript edge function called delete-user that does exactly what you‚Äôd expect it to do (among other things), and it worked fine back then. But two days ago, to my dismay, I tried deleting an account, and I received a 500 error from the API call.\nAfter adding some logs, I narrowed the error down to this line:\nconst { error: deleteError } = await adminClient.auth.admin.deleteUser(user.id);\nWhat could have changed to make this action fail? My first instinct was a foreign key constraint violation. Essentially, if there exists a table that references the another table, then one must specify that the record in the referencing table should be deleted if the underlying record in the referenced table is deleted. Without specifying that the deletion should cascade, then deleting the underlying record fails. This was entirely plausible because since I had first tested user deletion, I had created many tables.\nBut it‚Äôs pretty commonsense to have cascading deletion for user ID, so I doubted that I was missing it. And I was able to confirm that nothing was wrong in that regard.\nThen, I dug deeper and found the actual error message from PostgreSQL, which included this: ERROR: relation \\\\\\\"works\\\\\\\" does not exist (SQLSTATE 42P01). This was confusing at first because my works table didn‚Äôt even reference either my auth.users or profiles tables. However, it dawned on me that I had two columns used for keeping track of a work‚Äôs average rating: rating_count, the number of total ratings, and rating_sum, the sum of all ratings. The way I kept these up-to-date was by using an SQL function that was triggered after updates or deletions on the book_reviews table, which did have a user_id column.\nAfter trying a lot of things, what ended up being the issue was that in the SQL function, I needed to specify the schema name and write public.works since the original deletion was run from the auth schema. I excitedly retried deleting the account and was met with another 500, with the specific PostgreSQL error being ERROR: permission denied for table works (SQLSTATE 42501).\nThis really stumped me because\nI never see that error during normal application use, probably ruling out RLS policies, and the original edge function was using the service role key, which also bypasses role-related restrictions. I tried granting permissions to the service role and a few other things, at which point I decided to ask people online. I made posts in two subreddits, which were automatically removed, asked ‚ÄúX‚Äù to which noone responded, and asked in a PostgreSQL Discord server which was also fruitless. üò¢\nAfter taking my mind off the issue for about a day, I narrowed down the issue to the following: if the deletion originated with full permissions and cascaded to a process with fewer permissions, then I had to find out which processes could make that possible. Such an explanation should also account for why such a process could normally access the works table but could no longer when triggered by a user deletion.\nAs it turns out, SQL functions have something called SECURITY DEFINER, which you can add to them to give them the permissions of the ‚Äúowner‚Äù of the function, which is the postgres role and has full access. I guess the default must have been SECURITY INVOKER because that was the status of the SQL function I was investigating.\nAfter quickly changing the function to SECURITY DEFINER, I was happy to see the delete functionality work!\nSo why did SECURITY INVOKER not work? Right now, the most logical explanation I can think of is that while creating an admin client using the service role key gives basically unrestricted access to the tables through the API, when used to run an SQL function, the context is still authenticated, resulting in restricted access (due to the RLS policies in place).\nAll in all, this whole ordeal was a nice break from writing a lot of code and a nice example of how we think we have fixed a bug and the real problem ends up being something else entirely.\n","wordCount":"698","inLanguage":"en","datePublished":"2025-07-22T01:32:37-05:00","dateModified":"2025-07-22T01:32:37-05:00","author":{"@type":"Person","name":"Jiming Chen"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jiming-chen.github.io/posts/securitydefiner/"},"publisher":{"@type":"Organization","name":"Jiming Chen","logo":{"@type":"ImageObject","url":"https://jiming-chen.github.io/icons/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jiming-chen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://jiming-chen.github.io/icons/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jiming-chen.github.io/about title="About Me"><span>About Me</span></a></li><li><a href=https://jiming-chen.github.io/projects/ title=Portfolio><span>Portfolio</span></a></li><li><a href=https://jiming-chen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://jiming-chen.github.io/courses/ title="Course Notes"><span>Course Notes</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">A PostgreSQL Bug I Had to Deal With</h1><div class=post-meta><span title='2025-07-22 01:32:37 -0500 -0500'>July 22, 2025</span>&nbsp;¬∑&nbsp;Jiming Chen</div></header><div class=post-content><p>Back in May, when first started working on one of my projects which uses PostgreSQL, I implemented a TypeScript edge function called <code>delete-user</code> that does exactly what you&rsquo;d expect it to do (among other things), and it worked fine back then. But two days ago, to my dismay, I tried deleting an account, and I received a 500 error from the API call.</p><p>After adding some logs, I narrowed the error down to this line:</p><p><code>const { error: deleteError } = await adminClient.auth.admin.deleteUser(user.id);</code></p><p>What could have changed to make this action fail? My first instinct was a foreign key constraint violation. Essentially, if there exists a table that references the another table, then one must specify that the record in the referencing table should be deleted if the underlying record in the referenced table is deleted. Without specifying that the deletion should cascade, then deleting the underlying record fails. This was entirely plausible because since I had first tested user deletion, I had created many tables.</p><p>But it&rsquo;s pretty commonsense to have cascading deletion for user ID, so I doubted that I was missing it. And I was able to confirm that nothing was wrong in that regard.</p><p>Then, I dug deeper and found the actual error message from PostgreSQL, which included this: <code>ERROR: relation \\\"works\\\" does not exist (SQLSTATE 42P01)</code>. This was confusing at first because my <code>works</code> table didn&rsquo;t even reference either my <code>auth.users</code> or <code>profiles</code> tables. However, it dawned on me that I had two columns used for keeping track of a work&rsquo;s average rating: <code>rating_count</code>, the number of total ratings, and <code>rating_sum</code>, the sum of all ratings. The way I kept these up-to-date was by using an SQL function that was triggered after updates or deletions on the <code>book_reviews</code> table, which did have a <code>user_id</code> column.</p><p>After trying a lot of things, what ended up being the issue was that in the SQL function, I needed to specify the schema name and write <code>public.works</code> since the original deletion was run from the <code>auth</code> schema. I excitedly retried deleting the account and was met with another 500, with the specific PostgreSQL error being <code>ERROR: permission denied for table works (SQLSTATE 42501)</code>.</p><p>This really stumped me because</p><ol><li>I never see that error during normal application use, probably ruling out RLS policies, and</li><li>the original edge function was using the service role key, which also bypasses role-related restrictions.</li></ol><p>I tried granting permissions to the service role and a few other things, at which point I decided to ask people online. I made posts in two subreddits, which were automatically removed, asked &ldquo;X&rdquo; to which noone responded, and asked in a PostgreSQL Discord server which was also fruitless. &#x1f622;</p><p>After taking my mind off the issue for about a day, I narrowed down the issue to the following: if the deletion originated with full permissions and cascaded to a process with fewer permissions, then I had to find out which processes could make that possible. Such an explanation should also account for why such a process could normally access the <code>works</code> table but could no longer when triggered by a user deletion.</p><p>As it turns out, SQL functions have something called <code>SECURITY DEFINER</code>, which you can add to them to give them the permissions of the &ldquo;owner&rdquo; of the function, which is the <code>postgres</code> role and has full access. I guess the default must have been <code>SECURITY INVOKER</code> because that was the status of the SQL function I was investigating.</p><p>After quickly changing the function to <code>SECURITY DEFINER</code>, I was happy to see the delete functionality work!</p><p>So why did <code>SECURITY INVOKER</code> not work? Right now, the most logical explanation I can think of is that while creating an admin client using the service role key gives basically unrestricted access to the tables through the API, when used to run an SQL function, the context is still <code>authenticated</code>, resulting in restricted access (due to the RLS policies in place).</p><p>All in all, this whole ordeal was a nice break from writing a lot of code and a nice example of how we think we have fixed a bug and the real problem ends up being something else entirely.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://jiming-chen.github.io/>Jiming Chen</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>